import { Response, NextFunction } from 'express';
import { AuthRequest } from '../middleware/auth.middleware';
import { ContactService } from '../services/contact.service';
import { successResponse, paginatedResponse } from '../utils/response.util';
import { AppError } from '../middleware/error.middleware';

export class ContactController {
  private contactService: ContactService;

  constructor() {
    this.contactService = new ContactService();
  }

  // ===== Contacts =====

  getAll = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const { page = 1, limit = 20, ...filters } = req.query;
      const result = await this.contactService.findAll(
        filters,
        Number(page),
        Number(limit)
      );
      res.json(paginatedResponse(
        result.items,
        result.pagination.page,
        result.pagination.limit,
        result.pagination.total
      ));
    } catch (error) {
      next(error);
    }
  };

  getById = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const contact = await this.contactService.findById(req.params.contactId);
      res.json(successResponse(contact));
    } catch (error) {
      next(error);
    }
  };

  create = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const contact = await this.contactService.create(req.body);
      res.status(201).json(successResponse(contact, 'Contact created'));
    } catch (error) {
      next(error);
    }
  };

  update = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const contact = await this.contactService.update(req.params.contactId, req.body);
      res.json(successResponse(contact, 'Contact updated'));
    } catch (error) {
      next(error);
    }
  };

  delete = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const result = await this.contactService.delete(req.params.contactId);
      res.json(successResponse(result));
    } catch (error) {
      next(error);
    }
  };

  bulkDelete = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const result = await this.contactService.bulkDelete(req.body.contactIds);
      res.json(successResponse(result, 'Contacts deleted'));
    } catch (error) {
      next(error);
    }
  };

  bulkAddToList = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const { contactIds, listId } = req.body;
      const result = await this.contactService.bulkAddToList(contactIds, listId);
      res.json(successResponse(result, 'Contacts added to list'));
    } catch (error) {
      next(error);
    }
  };

  importCSV = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      if (!req.file) {
        throw new AppError(400, 'VALIDATION_ERROR', 'No file uploaded');
      }

      const { listId } = req.params;
      const { defaultCountryCode = '+1' } = req.body;

      const csvContent = req.file.buffer.toString('utf-8');
      const result = await this.contactService.importFromCSV(
        listId,
        csvContent,
        defaultCountryCode
      );

      res.json(successResponse(result, 'Contacts imported'));
    } catch (error) {
      next(error);
    }
  };

  updateStatus = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const { contactId } = req.params;
      const { listId, statusId } = req.body;
      const result = await this.contactService.updateContactStatus(contactId, listId, statusId);
      res.json(successResponse(result, 'Contact status updated'));
    } catch (error) {
      next(error);
    }
  };

  // ===== Lists =====

  getAllLists = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const lists = await this.contactService.findAllLists();
      res.json(successResponse(lists));
    } catch (error) {
      next(error);
    }
  };

  createList = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const list = await this.contactService.createList(req.body);
      res.status(201).json(successResponse(list, 'List created'));
    } catch (error) {
      next(error);
    }
  };

  updateList = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const list = await this.contactService.updateList(req.params.listId, req.body);
      res.json(successResponse(list, 'List updated'));
    } catch (error) {
      next(error);
    }
  };

  deleteList = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const result = await this.contactService.deleteList(req.params.listId);
      res.json(successResponse(result));
    } catch (error) {
      next(error);
    }
  };

  // ===== Kanban Statuses =====

  createStatus = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const list = await this.contactService.createStatus(req.params.listId, req.body);
      res.status(201).json(successResponse(list, 'Status created'));
    } catch (error) {
      next(error);
    }
  };

  updateStatusItem = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const { listId, statusId } = req.params;
      const list = await this.contactService.updateStatus(listId, statusId, req.body);
      res.json(successResponse(list, 'Status updated'));
    } catch (error) {
      next(error);
    }
  };

  deleteStatusItem = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const { listId, statusId } = req.params;
      const result = await this.contactService.deleteStatus(listId, statusId);
      res.json(successResponse(result));
    } catch (error) {
      next(error);
    }
  };

  // ===== Custom Properties =====

  getAllCustomProperties = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const properties = await this.contactService.findAllCustomProperties();
      res.json(successResponse(properties));
    } catch (error) {
      next(error);
    }
  };

  createCustomProperty = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const property = await this.contactService.createCustomProperty(req.body);
      res.status(201).json(successResponse(property, 'Custom property created'));
    } catch (error) {
      next(error);
    }
  };

  deleteCustomProperty = async (req: AuthRequest, res: Response, next: NextFunction) => {
    try {
      const result = await this.contactService.deleteCustomProperty(req.params.propertyId);
      res.json(successResponse(result));
    } catch (error) {
      next(error);
    }
  };
}

export const contactController = new ContactController();

